<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><meta name="google-site-verification" content="K7thEgdLm0UfRWJ5MGdF7sCcjClSzAlxFLPv2Oz5CGM"><title>Hexo</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content=""><meta name="keywords"><meta name="author" content="Lovelyun"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="http://example.com/atom.xml" title="Hexo"><script src='//unpkg.com/valine/dist/Valine.min.js'></script><meta name="generator" content="Hexo 7.2.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head><body><header><div class="header row"><ul id="nav_list" class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="博文" class="nav-list-link">博文</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="归档" class="nav-list-link">归档</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div><div id="nav_btn" class="nav-btn"><span></span><span></span><span></span></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><ul class="home post-list"><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/js/%E5%B0%A4%E9%9B%A8%E6%BA%AA%E5%B8%A6%E4%BD%A0%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAmini%20vue/" class="post-title-link">尤雨溪带你实现一个mini vue</a></h2><div class="post-info">2021-08-20<p id="busuanzi_container_page_pv" class="visit"><span id="busuanzi_value_page_pv"></span><span>次访问</span></p></div><div class="post-content"><p><img src="/../images/2021/mini_vue_1.png" alt="mini_vue_1"></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本篇文章主要是解析尤雨溪在<a target="_blank" rel="noopener" href="https://codepen.io/yyx990803/details/JjELqRo">codepen</a>上实现的一段mini-vue(solution)代码。</p>
<p>前面的文章，我们学习了怎么把数据变成响应式，怎么用虚拟dom局部刷新页面，现在我们在这两者的基础上，看怎么实现一个mini vue。</p>
<h2 id="代码解析"><a href="#代码解析" class="headerlink" title="代码解析"></a>代码解析</h2><p>先把所有的代码折叠起来看一下：</p>
<p><img src="/../images/2021/mini_vue_2.png" alt="mini_vue_2"></p>
<p>可以看到，在响应式、虚拟dom的实现上，和前文一模一样，只是在这两个功能上，增加了1个createApp函数，那么接下来我们主要看看createApp函数干了什么。</p>
<p>首先我们初始化了一个叫Component的常量，这个常量内部有data和render函数，data返回了{ count: 0 }，render返回一个虚拟dom，渲染这个虚拟dom就会向页面中添加一个div，div中显示count的值，并绑定了点击事件，点击div就让count自增1。（虚拟dom渲染不清楚的话，可以看看上文）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Component</span> = &#123;</span><br><span class="line">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">count</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">h</span>(</span><br><span class="line">      <span class="string">&#x27;div&#x27;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">onClick</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">count</span>++</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title class_">String</span>(<span class="variable language_">this</span>.<span class="property">count</span>)</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们来看看createApp函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createApp</span>(<span class="params">Component, container</span>) &#123;</span><br><span class="line">  <span class="comment">// implement this</span></span><br><span class="line">  <span class="keyword">const</span> state = <span class="title function_">reactive</span>(<span class="title class_">Component</span>.<span class="title function_">data</span>())</span><br><span class="line">  <span class="keyword">let</span> isMount = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">let</span> prevTree</span><br><span class="line">  <span class="title function_">watchEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> tree = <span class="title class_">Component</span>.<span class="property">render</span>.<span class="title function_">call</span>(state)</span><br><span class="line">    <span class="keyword">if</span> (isMount) &#123;</span><br><span class="line">      <span class="title function_">mount</span>(tree, container)</span><br><span class="line">      isMount = <span class="literal">false</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">patch</span>(prevTree, tree)</span><br><span class="line">    &#125;</span><br><span class="line">    prevTree = tree</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// calling this should actually mount the component.</span></span><br><span class="line"><span class="title function_">createApp</span>(<span class="title class_">Component</span>, <span class="variable language_">document</span>.<span class="title function_">getElementBy</span>(<span class="string">&#x27;app&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>进入函数后，首先将Component.data()即{ count: 0 }变成响应式后赋值给state，然后申明两个变量isMount和prevTree，然后调用watchEffect：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">watchEffect</span>(<span class="params">effect</span>) &#123;</span><br><span class="line">  activeEffect = effect</span><br><span class="line">  <span class="title function_">effect</span>()</span><br><span class="line">  activeEffect = <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么就执行了effect函数，申明并初始化tree常量，Component.render.call(state)的意思是执行Component中的render函数，并把render函数内的this指向state。</p>
<p>初次createApp时，isMount是true，所以接下来就直接渲染tree，并将isMount变成false，后面count数据变化时，触发effect函数再次走到if (isMount)这个判断时，isMount值就都是false，从而patch(prevTree, tree)，用新的tree对前一个tree打补丁，即局部刷新页面。</p>
<p>每次渲染或局部刷新完页面，就把当前的tree赋值给prevTree。</p>
<p>现在一个mini vue就实现了，点击页面上的0，0就会变成1，每次点击页面上的数字，数字就自增1。<br>（响应式和虚拟节点相关代码这里就不贴了，有需要去前文看，或者直接去codepen）</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>简单来说，之前实现的数据响应式，在使用时，只是在数据变化时把数据打印出来：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">watchEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(state.<span class="property">count</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>现在只是把watchEffect的传参effect的功能改一下，从简单的打印，改成渲染或局部更新页面，并且运用虚拟dom提高页面性能。从而实现数据变化时，页面自动局部刷新，也就是数据驱动视图。</p>
</div><a href="/js/%E5%B0%A4%E9%9B%A8%E6%BA%AA%E5%B8%A6%E4%BD%A0%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAmini%20vue/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/js/%E5%B0%A4%E9%9B%A8%E6%BA%AA%E5%B8%A6%E4%BD%A0%E5%AE%9E%E7%8E%B0%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9/" class="post-title-link">尤雨溪带你实现虚拟节点</a></h2><div class="post-info">2021-08-20<p id="busuanzi_container_page_pv" class="visit"><span id="busuanzi_value_page_pv"></span><span>次访问</span></p></div><div class="post-content"><p><img src="/../images/2021/Virtual_DOM_1.png" alt="Virtual_DOM_1"></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本篇文章主要是解析尤雨溪在<a target="_blank" rel="noopener" href="https://codepen.io/yyx990803/details/eYNEOvw">codepen</a>上实现的一段vdom代码。这段代码实现了一个简易的Virtual DOM。</p>
<p>Virtual DOM的作用是减少浏览器对页面的重绘，从而让用户体验更好，通过js把页面渲染相关的东西存起来，在数据更新的时候，不直接用新数据来重绘整个页面，而是先对比数据差异，在数据变化的地方局部渲染。接下来，我们就看看尤雨溪会怎么实现一个简易版本的Virtual DOM，从而让大家更好的理解Virtual DOM算法</p>
<p>代码解析<br>核心代码就两个函数，mount和patch，mount的字面意思是安装、镶嵌，嵌入，这里我们可以理解成渲染，patch的字面意思是补丁，这里我们可以理解成用新数据对页面打补丁，即局部更新页面。</p>
<p>首先我们看看mount函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">h</span>(<span class="params">tag, props, children</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; tag, props, children &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mount</span>(<span class="params">vnode, container, anchor</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> el = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(vnode.<span class="property">tag</span>);</span><br><span class="line">  vnode.<span class="property">el</span> = el;</span><br><span class="line">  <span class="comment">// props</span></span><br><span class="line">  <span class="keyword">if</span> (vnode.<span class="property">props</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> vnode.<span class="property">props</span>) &#123;</span><br><span class="line">      el.<span class="title function_">setAttribute</span>(key, vnode.<span class="property">props</span>[key]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (vnode.<span class="property">children</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> vnode.<span class="property">children</span> === <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">      el.<span class="property">textContent</span> = vnode.<span class="property">children</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      vnode.<span class="property">children</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">mount</span>(child, el);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (anchor) &#123;</span><br><span class="line">    container.<span class="title function_">insertBefore</span>(el, anchor)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    container.<span class="title function_">appendChild</span>(el);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> tree1 = <span class="title function_">h</span>(<span class="string">&quot;div&quot;</span>, &#123; <span class="attr">class</span>: <span class="string">&quot;red&quot;</span> &#125;, [</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&quot;span&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;hello&quot;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&quot;span&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;world&quot;</span>)</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="title function_">mount</span>(tree1, <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#app&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>上面这段代码，在页面中的#app元素中添加了tree1：</p>
<p><img src="/../images/2021/Virtual_DOM_2.png" alt="Virtual_DOM_2"></p>
<p>mount函数接受3个参数：vnode虚拟节点，container容器，anchor锚。<br>执行mount(tree1, document.querySelector(“#app”));，即渲染节点树tree1，tree1通过h函数包装后，返回的是一个对象，有tag, props, children3个属性。</p>
<p>在mount中，首先tree1的tag属性做处理，用createElement创建节点，然后把这个创建的节点el赋值给vnode的el属性。<br>然后对tree1的props属性做处理，如果props存在，就遍历props的key，通过setAttribute把props设置到el上。<br>然后对tree1的children属性做处理，如果children存在，就看看children的类型，是字符串的话，就把值赋值给el.textContent，否则就遍历children，对每个遍历到的值child执行mount(child, el)。所以对于children，最后都会走到类型是字符串那一步，从而更新到el的textContent中。<br>最后对anchor做处理，anchor的字面意思是锚，所以这里用来控制要渲染的节点树的位置。如果anchor存在，就在已有的节点anchor前面插入el节点，否则就把el节点添加到container中。</p>
<p>简单来说，mount函数根据虚拟节点来操作HTML页面，实现页面的更新。<br>有props时将props中的属性加到标签上；有children时，是字符串的children就直接把值写入父元素，否则就对children中的元素迭代mount函数；有anchor时就把创建的el加到anchor前面，否则就默认加到父元素container中。</p>
<p>接下来我们看看patch函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patch</span>(<span class="params">n1, n2</span>) &#123;</span><br><span class="line">  <span class="comment">// Implement this</span></span><br><span class="line">  <span class="comment">// 1. check if n1 and n2 are of the same type</span></span><br><span class="line">  <span class="keyword">if</span> (n1.<span class="property">tag</span> !== n2.<span class="property">tag</span>) &#123;</span><br><span class="line">    <span class="comment">// 2. if not, replace</span></span><br><span class="line">    <span class="keyword">const</span> parent = n1.<span class="property">el</span>.<span class="property">parentNode</span></span><br><span class="line">    <span class="keyword">const</span> anchor = n1.<span class="property">el</span>.<span class="property">nextSibling</span></span><br><span class="line">    parent.<span class="title function_">removeChild</span>(n1.<span class="property">el</span>)</span><br><span class="line">    <span class="title function_">mount</span>(n2, parent, anchor)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> el = n2.<span class="property">el</span> = n1.<span class="property">el</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3. if yes</span></span><br><span class="line">  <span class="comment">// 3.1 diff props</span></span><br><span class="line">  <span class="keyword">const</span> oldProps = n1.<span class="property">props</span> || &#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> newProps = n2.<span class="property">props</span> || &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> newProps) &#123;</span><br><span class="line">    <span class="keyword">const</span> newValue = newProps[key]</span><br><span class="line">    <span class="keyword">const</span> oldValue = oldProps[key]</span><br><span class="line">    <span class="keyword">if</span> (newValue !== oldValue) &#123;</span><br><span class="line">      <span class="keyword">if</span> (newValue != <span class="literal">null</span>) &#123;</span><br><span class="line">        el.<span class="title function_">setAttribute</span>(key, newValue)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        el.<span class="title function_">removeAttribute</span>(key)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> oldProps) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(key <span class="keyword">in</span> newProps)) &#123;</span><br><span class="line">      el.<span class="title function_">removeAttribute</span>(key)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 3.2 diff children</span></span><br><span class="line">  <span class="keyword">const</span> oc = n1.<span class="property">children</span></span><br><span class="line">  <span class="keyword">const</span> nc = n2.<span class="property">children</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> nc === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nc !== oc) &#123;</span><br><span class="line">      el.<span class="property">textContent</span> = nc</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(nc)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(oc)) &#123;</span><br><span class="line">      <span class="comment">// array diff</span></span><br><span class="line">      <span class="keyword">const</span> commonLength = <span class="title class_">Math</span>.<span class="title function_">min</span>(oc.<span class="property">length</span>, nc.<span class="property">length</span>)</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; commonLength; i++) &#123;</span><br><span class="line">        <span class="title function_">patch</span>(oc[i], nc[i])</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (nc.<span class="property">length</span> &gt; oc.<span class="property">length</span>) &#123;</span><br><span class="line">        nc.<span class="title function_">slice</span>(oc.<span class="property">length</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">c</span> =&gt;</span> <span class="title function_">mount</span>(c, el))</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oc.<span class="property">length</span> &gt; nc.<span class="property">length</span>) &#123;</span><br><span class="line">        oc.<span class="title function_">slice</span>(nc.<span class="property">length</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">c</span> =&gt;</span> &#123;</span><br><span class="line">          el.<span class="title function_">removeChild</span>(c.<span class="property">el</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      el.<span class="property">innerHTML</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">      nc.<span class="title function_">forEach</span>(<span class="function"><span class="params">c</span> =&gt;</span> <span class="title function_">mount</span>(c, el))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> tree2 = <span class="title function_">h</span>(<span class="string">&quot;div&quot;</span>, &#123; <span class="attr">class</span>: <span class="string">&quot;green&quot;</span> &#125;, [</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&quot;span&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;this has &quot;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&quot;span&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;changed&quot;</span>)</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="title function_">patch</span>(tree1, tree2);</span><br></pre></td></tr></table></figure>

<p>patch函数接受2个虚拟节点的参数。</p>
<p>首先判断老节点和新节点的标签是否相同，不同的话就直接用新节点替换掉老节点，也不用继续往下走了。比如老节点是div，新节点是span，那么这2个节点就完全不一样，就需要直接替换掉整个节点。<br>替换也很简单，获取老节点的父元素parent和紧跟的节点anchor，然后删除老节点，然后把新节点渲染到anchor前面。</p>
<p>如果类型一样，比如都是div，那么接着找差异。<br>先初始化el，老节点的el就是在mount渲染是赋值的tag，因为类型一样，所以我们将这个值也赋值给新节点。</p>
<p>接下来寻找props的差异，因为props是设置在el上的，所以我们由外而内逐步寻找差异。<br>首先初始化新修props，取虚拟节点传入的props，没传就是{}。<br>然后遍历新props中的key,通过key取新就props对于的value，一旦新旧value不同，就要做处理，新value存在就setAttribute，不存在就removeAttribute。比如这里遍历到的key是class，那么newValue就是green，而oldValue是red，所以将class设置成green，如果我们的tree2没有传{ class: “green” }，那newValue就不存在，那就会移除el上的class属性。</p>
<p>newProps遍历完了，这一步将newProps中不为空的属性设置到了el上。<br>那有的属性oldProps有，而newProps没有呢？<br>所以接下来就是遍历oldProps，如果oldProps中的key，在newProps中没有，就移除这个属性。</p>
<p>处理完props的差异，接下来处理children的差异。</p>
<p>首先把新旧节点的children分别赋值给oc和nc，代表oldChildren和newChildren。</p>
<p>如果nc是字符串，还跟oc不一样，就把nc直接赋值给el.textContent。<br>否则，看nc是不是数组，是的话，就继续往下看。<br>如果oc不是数组，那就说明nc和oc开始变得不一样了，这时直接将el中的内容清空，遍历nc数组，对nc中的内容逐个mount渲染到页面。<br>oc也是数组的话，就需要继续寻找差异，这时我们先去oc和nc数组长度中较小的值，在这个长度内，逐个迭代patch函数来打补丁，最后迭代到nc是字符串，直接更新el.textContent。这样就处理完了oc和nc长度相同的部分，比如oc长3，nc长5，那么oc和nc的前3个就处理完了，接下来就处理剩下的2个。<br>如果nc比oc长，我们只需要把剩下的2个渲染；<br>如果nc比oc短，比如nc长1，oc长7，我们把nc和oc的第一个处理了，oc还剩后6个没处理，这时我们只需要截取oc的后6个，然后逐个删除。</p>
<p>到这里，我们的children也找出了差异，并把差异部分更新到页面，实现了局部更新。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>虚拟节点的原理是不是很简单？我们不谈高大上的diff算法，Virtual DOM，局部更新等名词，就只是简单的实现一个通过js来局部刷新dom的功能，看起来就简单多了。</p>
<p><img src="/../images/2021/Virtual_DOM_3.png" alt="Virtual_DOM_3"></p>
</div><a href="/js/%E5%B0%A4%E9%9B%A8%E6%BA%AA%E5%B8%A6%E4%BD%A0%E5%AE%9E%E7%8E%B0%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/js/%E5%B0%A4%E9%9B%A8%E6%BA%AA%E6%95%99%E4%BD%A0%E5%86%99%E8%BF%9B%E9%98%B6%E7%89%88%E5%93%8D%E5%BA%94%E5%BC%8F/" class="post-title-link">尤雨溪教你写进阶版响应式</a></h2><div class="post-info">2021-08-19<p id="busuanzi_container_page_pv" class="visit"><span id="busuanzi_value_page_pv"></span><span>次访问</span></p></div><div class="post-content"><p><img src="/../images/2021/Reactivity_defineProperty.png" alt="Reactivity_defineProperty"></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>上一篇，我们解析了尤雨溪的初级版响应式代码，一定觉得初级版的响应式和我们平常用的vue3相差太远了，定义一个响应式对象，竟然还要手写get和set，而我们日常使用vue3来定义一个响应式对象只需要用ref或者reactive包起来。</p>
<p>那么，这一篇我们看看尤雨溪对初级版做了哪些升级。</p>
<h2 id="封装reactive"><a href="#封装reactive" class="headerlink" title="封装reactive"></a>封装reactive</h2><p>上一版中，定义响应式变量需手写get和set：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">count</span>() &#123;</span><br><span class="line">    dep.<span class="title function_">depend</span>()</span><br><span class="line">    <span class="keyword">return</span> actualCount</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">set</span> <span class="title function_">count</span>(<span class="params">newCount</span>) &#123;</span><br><span class="line">    actualCount = newCount</span><br><span class="line">    dep.<span class="title function_">notify</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么这一版首先就将这一步封装起来。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">reactive</span>(<span class="params">raw</span>) &#123;</span><br><span class="line">  <span class="comment">// use Object.defineProperty</span></span><br><span class="line">  <span class="comment">// 1. iterate over the existing keys</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(raw).<span class="title function_">forEach</span>(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 2. for each key: create a corresponding dep</span></span><br><span class="line">    <span class="keyword">const</span> dep = <span class="keyword">new</span> <span class="title class_">Dep</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. rewrite the property into getter/setter</span></span><br><span class="line">    <span class="keyword">let</span> realValue = raw[key]</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(raw, key, &#123;</span><br><span class="line">      <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// 4. call dep methods inside getter/setter</span></span><br><span class="line">        dep.<span class="title function_">depend</span>()</span><br><span class="line">        <span class="keyword">return</span> realValue</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title function_">set</span>(<span class="params">newValue</span>) &#123;</span><br><span class="line">        realValue = newValue</span><br><span class="line">        dep.<span class="title function_">notify</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> raw</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>封装后，定义响应式变量只需要：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> state = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">  <span class="attr">count</span>: <span class="number">0</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>现在看来，是不是和vue3的写法一样了呢？</p>
<p>接下来我们解读下这个优化。</p>
<p>首先翻译几个名词，为什么想翻译一下呢？因为我觉得尤雨溪写的代码命名非常好，一段代码读下来，就像看小说，即使不懂编程，也会大概知道是做什么。</p>
<p>reactive: 反应的<br>raw: 未加工的、不成熟的</p>
<p>这两个变量名取的好呀，一眼看过去，函数reactive接受一个未加工的变量raw，然后返回了raw。咱们不看内容，就可以猜到reactive函数做了什么。</p>
<p>下面我们来看看reactive函数的内容（代码中的英文注释也是尤雨溪写的哦）。</p>
<p>传进来的raw对象，我们对key进行遍历，取得key对应的value值后，立即重写raw。</p>
<p>这里用到Object.defineProperty(obj, prop, descriptor)，这个方法会直接在一个对象obj上定义一个新属性，或者修改一个对象的现有属性，并返回此对象。其中obj是要定义属性的对象，prop是要定义或修改的属性的key，descriptor是更新或定义的属性的描述。</p>
<p>所以这里重写时，给key值对应的value绑定了get和set函数，实现了上一版手动绑定的过程。</p>
<p>然后优化watchEffect，执行effect后立刻将activeEffect置空，防止不必要的订阅行为。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">watchEffect</span>(<span class="params">effect</span>) &#123;</span><br><span class="line">  activeEffect = effect</span><br><span class="line">  <span class="title function_">effect</span>()</span><br><span class="line">  activeEffect = <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="再次进阶"><a href="#再次进阶" class="headerlink" title="再次进阶"></a>再次进阶</h2><p>上面的优化比较小，只是简化了响应式变量的定义，接下来我们看看尤雨溪还能做什么优化。</p>
<p>首先，重写了Dep类。<br>之前的Dep类比较简单，只有一个发布订阅模式。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> activeEffect</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dep</span> &#123;</span><br><span class="line">  subscribers = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">  <span class="title function_">depend</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (activeEffect) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">subscribers</span>.<span class="title function_">add</span>(activeEffect)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">notify</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">subscribers</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">effect</span> =&gt;</span> <span class="title function_">effect</span>())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>优化后：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> activeEffect</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dep</span> &#123;</span><br><span class="line">  <span class="comment">// imeplement this</span></span><br><span class="line">  subscribers = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_value</span> = value</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">value</span>() &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">depend</span>()</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_value</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> <span class="title function_">value</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_value</span> = value</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">notify</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">depend</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (activeEffect) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">subscribers</span>.<span class="title function_">add</span>(activeEffect)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">notify</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">subscribers</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">effect</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">effect</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>多了一个叫_value的私有变量，并且这个_value是响应式的。然后写了一个reactiveHandlers函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// proxy version</span></span><br><span class="line"><span class="keyword">const</span> reactiveHandlers = &#123;</span><br><span class="line">  <span class="title function_">get</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="comment">// how do we get the dep for this key?</span></span><br><span class="line">    <span class="keyword">const</span> value = <span class="title function_">getDep</span>(target, key).<span class="property">value</span></span><br><span class="line">    <span class="keyword">if</span> (value &amp;&amp; <span class="keyword">typeof</span> value === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">reactive</span>(value)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> value</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">set</span>(<span class="params">target, key, value</span>) &#123;</span><br><span class="line">    <span class="title function_">getDep</span>(target, key).<span class="property">value</span> = value</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着是getDep函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> targetToHashMap = <span class="keyword">new</span> <span class="title class_">WeakMap</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getDep</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> depMap = targetToHashMap.<span class="title function_">get</span>(target)</span><br><span class="line">  <span class="keyword">if</span> (!depMap) &#123;</span><br><span class="line">    depMap = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    targetToHashMap.<span class="title function_">set</span>(target, depMap)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> dep = depMap.<span class="title function_">get</span>(key)</span><br><span class="line">  <span class="keyword">if</span> (!dep) &#123;</span><br><span class="line">    dep = <span class="keyword">new</span> <span class="title class_">Dep</span>(target[key])</span><br><span class="line">    depMap.<span class="title function_">set</span>(key, dep)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> dep</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后就是用Proxy替代defineProperty重写reactive函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">reactive</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(obj, reactiveHandlers)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里补充下Proxy知识点：</p>
<blockquote>
<p>Proxy 对象用于创建一个对象的代理，从而实现基本操作的拦截和自定义（如属性查找、赋值、枚举、函数调用等）。</p>
</blockquote>
<p>语法是<code>const p = new Proxy(target, handler)</code>，<br>target是要使用 Proxy 包装的目标对象（可以是任何类型的对象，包括原生数组，函数，甚至另一个代理）。<br>handler通常以函数作为属性的对象，各属性中的函数分别定义了在执行各种操作时代理 p 的行为。<br>示例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> handler = &#123;</span><br><span class="line">  <span class="attr">get</span>: <span class="keyword">function</span>(<span class="params">obj, prop</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> prop <span class="keyword">in</span> obj ? obj[prop] : <span class="number">37</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Proxy</span>(&#123; <span class="attr">a</span>: <span class="number">1</span> &#125;, handler);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(p.<span class="property">a</span>, p.<span class="property">b</span>); <span class="comment">// 1, 37</span></span><br></pre></td></tr></table></figure>

<p>补充完Proxy知识点，我们再去看reactive。</p>
<p>我们用reactiveHandlers代理obj，读写obj时会进入reactiveHandlers，读的时候，通过getDep获取value值，如果value是object类型，就将value变成响应式，然后返回value；写的时候就把新值写到getDep获取的value上。</p>
<p>在getDep函数中，用到了Map和WeakMap。<br>Map对象保存键值对，并且能够记住键的原始插入顺序。任何值(对象或者原始值) 都可以作为一个键或一个值。<br>WeakMap对象是一组键&#x2F;值对的集合，其中的键是弱引用的。其键必须是对象，而值可以是任意的。</p>
<p>getDep中，首先去targetToHashMap中获取target，并赋值给depMap，没有获取到的话，就将target作为键，new Map()生成的depMap作为值，存到targetToHashMap中。</p>
<p>然后在depMap中取key的值，取不到的话，就new Dep(target[key])作为value和key一起，组成键值对，加到depMap中。最后返回dep。</p>
<p>使用还是一样：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> state = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">  <span class="attr">count</span>: <span class="number">0</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">watchEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(state.<span class="property">count</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">state.<span class="property">count</span>++</span><br></pre></td></tr></table></figure>

<p>在上面的代码中加上一些打印，使代码流程看得更加清楚：</p>
<p><img src="/../images/2021/reactivity_proxy_code.png" alt="reactivity_proxy_code"></p>
<p>可见getDep最后返回了一个Dep的实例。</p>
<p>还有什么不清楚的地方，自行断点调试。</p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>所以，看到这里，你明白Proxy比起defineProperty，在实现vue的响应式时，有什么好处吗？</p>
<p>后期后空，我们继续学习尤雨溪会怎么实现一个mini vue。</p>
</div><a href="/js/%E5%B0%A4%E9%9B%A8%E6%BA%AA%E6%95%99%E4%BD%A0%E5%86%99%E8%BF%9B%E9%98%B6%E7%89%88%E5%93%8D%E5%BA%94%E5%BC%8F/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/js/%E5%B0%A4%E9%9B%A8%E6%BA%AA%E6%95%99%E4%BD%A0%E5%86%99%E5%88%9D%E7%BA%A7%E7%89%88%E5%93%8D%E5%BA%94%E5%BC%8F/" class="post-title-link">尤雨溪教你写初级版响应式</a></h2><div class="post-info">2021-08-18<p id="busuanzi_container_page_pv" class="visit"><span id="busuanzi_value_page_pv"></span><span>次访问</span></p></div><div class="post-content"><p><img src="/../images/2021/Reactivity_Dep.png" alt="Reactivity_Dep"></p>
<p>本篇文章主要是解析尤雨溪在<a target="_blank" rel="noopener" href="https://codepen.io/yyx990803/details/eYNEOvw">codepen</a>上实现的一段Reactivity(Dep)代码，我们拆成2部分来看。</p>
<h2 id="Part-1-实现响应式"><a href="#Part-1-实现响应式" class="headerlink" title="Part 1 实现响应式"></a>Part 1 实现响应式</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> activeEffect</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dep</span> &#123;</span><br><span class="line">  subscribers = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">  <span class="title function_">depend</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (activeEffect) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">subscribers</span>.<span class="title function_">add</span>(activeEffect)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">notify</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">subscribers</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">effect</span> =&gt;</span> <span class="title function_">effect</span>())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">watchEffect</span>(<span class="params">effect</span>) &#123;</span><br><span class="line">  activeEffect = effect</span><br><span class="line">  <span class="title function_">effect</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先，定义了一个全局变量activeEffect。</p>
<p>然后写了一个Dep类,它有一个subscribers属性，depend和notify方法。<br>subscribers是Set对象，Set对象允许存储任何类型的唯一值，无论是原始值或者是对象引用。</p>
<p><img src="/../images/2021/Set.png" alt="Set"></p>
<p>调用depend时，如果activeEffect存在，就将其加到subscribers中。<br>调用notify时，遍历subscribers，执行遍历到的对象。</p>
<p>watchEffect函数接收一个effect参数，调用时将effect参数赋值给全局变量activeEffect，然后执行effect。</p>
<p>从上面的解析可以看到，代码实现的非常简陋，没有做类型判断，所以调用时注意传参的类型，watchEffect传参须是函数。</p>
<p>现在功能实现好了，怎么用呢？我们继续往下看。</p>
<h2 id="Part-2-使用"><a href="#Part-2-使用" class="headerlink" title="Part 2 使用"></a>Part 2 使用</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// usage -----------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> dep = <span class="keyword">new</span> <span class="title class_">Dep</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> actualCount = <span class="number">0</span></span><br><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">count</span>() &#123;</span><br><span class="line">    dep.<span class="title function_">depend</span>()</span><br><span class="line">    <span class="keyword">return</span> actualCount</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">set</span> <span class="title function_">count</span>(<span class="params">newCount</span>) &#123;</span><br><span class="line">    actualCount = newCount</span><br><span class="line">    dep.<span class="title function_">notify</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">watchEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(state.<span class="property">count</span>)</span><br><span class="line">&#125;) <span class="comment">// 0</span></span><br><span class="line"></span><br><span class="line">state.<span class="property">count</span>++ <span class="comment">// 1</span></span><br></pre></td></tr></table></figure>

<p>我们在适当的地方加上打印，那么程序的走向将更加明了：</p>
<p><img src="/../images/2021/watchEffect.png" alt="watchEffect"></p>
<p>上面的打印能看懂，就不用看下面这些了。</p>
<p>首先创建一个Dep对象类型的实例dep。</p>
<p>然后创建一个actualCount变量，并初始化，值为0。</p>
<p>然后创建一个state变量，state变量内部使用get和set语法。<br>其中get语法和set语法分别将对象属性和一个函数绑定，在获取或设置该属性时，触发绑定的函数执行。<br>上面创建并初始化state的代码意思是获取state.count时，执行get后面的函数，调用dep.depend，然后返回actualCount。<br>设置state.count时，比如state.count &#x3D; 1，就执行set后面的函数，把1赋值给actualCount，然后调用dep.notify。</p>
<p>然后调用watchEffect函数，传入的参数是匿名函数() &#x3D;&gt; { console.log(state.count) }。<br>watchEffect函数中，将传入的匿名函数赋值给全局变量activeEffect，然后执行这个匿名函数，于是打印state.count的值，而打印state.count的值，就需要获取state.count，就会触发get绑定的函数，于是执行dep.depend，由于此时的activeEffect值是匿名函数，所以将该匿名函数加到subscribers中，然后返回actualCount，所以得到的值是0，打印了0。</p>
<p>最后state.count++，使state.count自增1，这里先获取再自增，所以会触发get和set,由于全局变量activeEffect一直存在，所以get时会将activeEffect加入subscribers，而subscribers内的值不会重复，所以一直就只有一个值，那就是最开始加入的匿名函数。<br>触发set时就执行和set绑定的函数，把1赋值给actualCount,然后执行dep.notify，notify中遍历subscribers，遍历到了之前加入的匿名函数，就执行了该匿名函数，于是打印了1。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>首先我们翻译几个名词。</p>
<ul>
<li>subscribers: 订阅者，用户</li>
<li>depend: 依赖</li>
<li>notify: 通知，公布</li>
<li>actual: 目前的</li>
<li>effect: 达到目的</li>
</ul>
<p>从这些名词中，你是不是已经想到了一些javascript的设计模式？这里就不做讨论，感兴趣的话自行学习。</p>
<p>所以，上面的代码，翻译成白话，调用watchEffect来执行一个函数，这个函数获取了一个值count，于是把这个函数加到监听者列表，当count变化时，就会遍历监听者列表，于是遍历到刚刚加入的函数，于是执行了它，于是就获取到了当前的count值(actualCount)。</p>
<p>打个比方，同学小明，查询(watchEffect)了一下iphone12(state)的价格(count)，获取价格时系统就把小明加入订阅者，在价格变化时，通知小明同学最新的价格。</p>
<p>这一期的代码比较简陋，但是循序渐进，由简入深，下期我们继续讲解进阶版。</p>
</div><a href="/js/%E5%B0%A4%E9%9B%A8%E6%BA%AA%E6%95%99%E4%BD%A0%E5%86%99%E5%88%9D%E7%BA%A7%E7%89%88%E5%93%8D%E5%BA%94%E5%BC%8F/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/%E5%89%8D%E7%AB%AF%E5%A6%82%E4%BD%95%E5%9C%A8%E5%83%8F%E7%B4%A0%E7%BA%A7%E5%88%AB%E6%93%8D%E7%BA%B5%E5%9B%BE%E7%89%87/" class="post-title-link">前端如何在像素级别操纵图片</a></h2><div class="post-info">2021-08-12<p id="busuanzi_container_page_pv" class="visit"><span id="busuanzi_value_page_pv"></span><span>次访问</span></p></div><div class="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前端也可以做图像处理？<br>是的，可以。<br>今天我们要介绍一种在前端处理图像的方式。</p>
<p>对于一般的图片，我们用专业的软件（比如PhotoShop、mark man等等）放大到最后，就会看到很多小格子，这一个一个的格子，就是像素，每个格子，即每个像素，都代表不同的颜色。<br>而颜色都可以用rgba的形式表示，比如白色<code>rgba(255, 255, 255, 1)</code>，其中r代表红色，g代表绿色，b代表蓝色，a代表透明度，rgb代表的色值取值范围是[0, 255]，a代表的透明度取值范围是[0, 1]。</p>
<p><img src="/../images/2021/px.png" alt="px"></p>
<h2 id="获取像素数据"><a href="#获取像素数据" class="headerlink" title="获取像素数据"></a>获取像素数据</h2><p>下面将带领大家一步一步来看怎么获取像素数据。</p>
<p>首先，我们创建一个页面。提供选择图片功能。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>test<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">canvas</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">300px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;fileInput&quot;</span> <span class="attr">name</span>=<span class="string">&quot;选择图片&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;wrap-image&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">&quot;canvas&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>选择图片后，需要将图片显示到canvas中，我们在上面的script标签中加入下面的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fileInput = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;fileInput&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> canvas = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;canvas&#x27;</span>);</span><br><span class="line"><span class="keyword">let</span> context</span><br><span class="line">fileInput.<span class="title function_">addEventListener</span>(<span class="string">&#x27;change&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> img = <span class="keyword">new</span> <span class="title class_">Image</span></span><br><span class="line">    img.<span class="property">src</span> = <span class="variable constant_">URL</span>.<span class="title function_">createObjectURL</span>(e.<span class="property">target</span>.<span class="property">files</span>[<span class="number">0</span>]);</span><br><span class="line">    img.<span class="property">onload</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        canvas.<span class="property">width</span> = img.<span class="property">width</span></span><br><span class="line">        canvas.<span class="property">height</span> = img.<span class="property">height</span></span><br><span class="line">        context = canvas.<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>);</span><br><span class="line">        context.<span class="title function_">drawImage</span>(img, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/../images/2021/showImage.png" alt="showImage"></p>
<p>现在图片显示出来了，那要怎么获取图片像素数据呢？这里我们用到canvas的getImageData对象，他的用法如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> myImageData = context.<span class="title function_">getImageData</span>(left, top, width, height);</span><br></pre></td></tr></table></figure>

<p>那么在本例中，我们在drawImage后可以接着getImageData，在img.onload中继续加入下面的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> imageData = context.<span class="title function_">getImageData</span>(<span class="number">0</span>, <span class="number">0</span>, img.<span class="property">width</span>, img.<span class="property">height</span>);</span><br></pre></td></tr></table></figure>

<p>将imageData打印出来，可以看到：</p>
<p><img src="/../images/2021/imageData.png" alt="imageData"></p>
<p>现在，我们就获取到了图片的像素数据，它在imageData对象的data中。</p>
<h2 id="读取像素点"><a href="#读取像素点" class="headerlink" title="读取像素点"></a>读取像素点</h2><p>上面我们获取到了像素数据，但要怎么读取像素点呢？<br>首先，我们来看看imageData对象的data对象是什么。</p>
<p>data是<code>Uint8ClampedArray</code>类型的一维数组，包含着RGBA格式的整型数据。每个部份被分配到一个在数组内连续的索引，左上角像素的红色部份在数组的索引0位置。像素从左到右被处理，然后往下。data包含<code>width × height × 4</code> bytes数据，索引值从<code>0</code>到<code>(width × height × 4) - 1</code>。</p>
<p>例如，要读取图片中位于第50行，第200列的像素的蓝色部份，你会写以下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> b = imageData.<span class="property">data</span>[((<span class="number">50</span> * (img.<span class="property">width</span> * <span class="number">4</span>)) + (<span class="number">200</span> * <span class="number">4</span>)) + <span class="number">2</span>];</span><br></pre></td></tr></table></figure>

<p>那么根据行(<code>row</code>)、列(<code>col</code>)读取一个像素点的r&#x2F;g&#x2F;b&#x2F;a值的公式是：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> rIndex = row * (img.<span class="property">width</span> * <span class="number">4</span>) + col * <span class="number">4</span> <span class="comment">// data中r值的索引</span></span><br><span class="line"><span class="keyword">let</span> r = imageData.<span class="property">data</span>[rIndex];</span><br><span class="line"><span class="keyword">let</span> g = imageData.<span class="property">data</span>[(rIndex + <span class="number">1</span>];</span><br><span class="line"><span class="keyword">let</span> b = imageData.<span class="property">data</span>[(rIndex + <span class="number">2</span>];</span><br><span class="line"><span class="keyword">let</span> a = imageData.<span class="property">data</span>[(rIndex + <span class="number">3</span>];</span><br></pre></td></tr></table></figure>

<h2 id="操作像素"><a href="#操作像素" class="headerlink" title="操作像素"></a>操作像素</h2><p>上面我们获取到了图片数据，并读取到了像素点，能读取像素点，是不是也可以设置像素点呢？<br>是的，下面我们将用canvas的putImageData来更新像素。<br>这里我们将实现一个invert的效果，在获取imageData之后调用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">invert</span>(<span class="params">imageData</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; data &#125; = imageData</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; data.<span class="property">length</span>; i += <span class="number">4</span>) &#123;</span><br><span class="line">        data[i] = <span class="number">255</span> - data[i]; <span class="comment">// red</span></span><br><span class="line">        data[i + <span class="number">1</span>] = <span class="number">255</span> - data[i + <span class="number">1</span>]; <span class="comment">// green</span></span><br><span class="line">        data[i + <span class="number">2</span>] = <span class="number">255</span> - data[i + <span class="number">2</span>]; <span class="comment">// blue</span></span><br><span class="line">    &#125;</span><br><span class="line">    context.<span class="title function_">putImageData</span>(imageData, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../images/2021/invertImage.png" alt="invertImage"></p>
<p>总结<br>1、前端的canvas不仅可以显示图片，还可以获取到图片数据。<br>2、数据中有图片的宽和高，还有像素信息，它对应着图片从左到右，再从上到下的像素点的rgba值。<br>3、我们可以读到某行某列的像素数据，同样的我们也可以写。<br>4、对不同的颜色通道及透明度做一系列运算，就可以得到颜色变化了的新图片。<br>5、改变图片的颜色，主要应用在图片滤镜上，前端的基础滤镜，都是这个原理。</p>
</div><a href="/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/%E5%89%8D%E7%AB%AF%E5%A6%82%E4%BD%95%E5%9C%A8%E5%83%8F%E7%B4%A0%E7%BA%A7%E5%88%AB%E6%93%8D%E7%BA%B5%E5%9B%BE%E7%89%87/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/%E5%89%8D%E7%AB%AF%E5%A6%82%E4%BD%95%E9%80%9A%E8%BF%87LUT%E5%AE%9E%E7%8E%B0%E5%9B%BE%E7%89%87%E6%BB%A4%E9%95%9C/" class="post-title-link">前端如何通过LUT实现图片滤镜</a></h2><div class="post-info">2021-08-09<p id="busuanzi_container_page_pv" class="visit"><span id="busuanzi_value_page_pv"></span><span>次访问</span></p></div><div class="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>说到图片滤镜，相信大家都不陌生，比如什么晨光效果、小清新效果，但大家都清楚滤镜效果是怎么实现的吗？比如下面两个好看的滤镜效果：</p>
<p><img src="/../images/2021/film-emulation-lut-21613370085.jpg" alt="film-emulation-lut-21613370085"><br><img src="/../images/2021/lut-film-emulation-271613371435.jpg" alt="lut-film-emulation-271613371435"></p>
<p>在前端，一般的图像处理库，都是基于算法来实现的，获取图片的像素，解析成R、G、B，然后对这3个颜色一通操作，比如R都变成255，G都减25…，或者复杂点，进行个卷积运算，比如fabric.js的滤镜效果。<br>但是这些算法实现的滤镜效果不仅数量少，效果也不够丰富，只能实现些简单的效果，比如反色、灰阶、怀旧等等。如果设计师在PS中对图片进行了风格调色，比如相机校正、曲线、色彩分割、HSL调整等等项目，在程序上我们又要如何实现呢？<br>本文要介绍的图片滤镜实现方式就可以解决上面的问题，只要是设计师实现的滤镜效果，我们都可以实现，而且，还有很多免费的滤镜效果可以使用，不一定需要设计师输出，滤镜效果好，并且处理速度快，这种方式就是3D LUT（look up table），即3D颜色查找表。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="3D-LUT资源文件"><a href="#3D-LUT资源文件" class="headerlink" title="3D LUT资源文件"></a>3D LUT资源文件</h3><p>设计师输出.CUBE文件，或者网上找免费资源。<br>图片的风格处理大都比较复杂，对设计师来说，<code>Photoshop</code>中内建了几个影片的<code>3D LUT</code>电影调色档，也可以用外部导入的电影调色档，所以我们也可以直接用设计师们用到的外部电影调色档，资源的格式一般是.CUBE文件。</p>
<h3 id="3D-LUT资源文件格式处理"><a href="#3D-LUT资源文件格式处理" class="headerlink" title="3D LUT资源文件格式处理"></a>3D LUT资源文件格式处理</h3><p>如果前端直接使用.CUBE文件，不仅文件体积大，而且需要做文件解析，但是如果把.CUBE文件转成png，不仅体积小很多，也不用解析文本，直接解析png图片中的像素即可，这里推荐一个<a target="_blank" rel="noopener" href="http://yyb.gtimg.com/aiplat/static/qcloud-cube-to-png.html">cube转png小工具</a>，处理后的png一般是下面这样，宽高尺寸是512x512。</p>
<p><img src="/../images/2021/Going-for-a-walk.png" alt="Going-for-a-walk"></p>
<h2 id="前端实现基于3D-LUT的滤镜"><a href="#前端实现基于3D-LUT的滤镜" class="headerlink" title="前端实现基于3D LUT的滤镜"></a>前端实现基于3D LUT的滤镜</h2><p>下面我们写一个简单的页面，实现用户上传原图和lut图，就可以得到处理后的图，并且可以点击下载处理后的图。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>LUT<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">canvas</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">300px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">id</span>=<span class="string">&quot;downloadButton&quot;</span>&gt;</span>下载<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;fileInput&quot;</span> <span class="attr">name</span>=<span class="string">&quot;选择图片&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;lutInput&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;wrap-image&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">&quot;imageUpload&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">&quot;lutUpload&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">&quot;canvasOutput&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> imgElement = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;imageUpload&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> lutElement = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;lutUpload&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> outputElement = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;canvasOutput&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> fileInput = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;fileInput&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> lutInput = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;lutInput&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            fileInput.<span class="title function_">addEventListener</span>(<span class="string">&#x27;change&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> img = <span class="keyword">new</span> <span class="title class_">Image</span></span></span><br><span class="line"><span class="language-javascript">                img.<span class="property">src</span> = <span class="variable constant_">URL</span>.<span class="title function_">createObjectURL</span>(e.<span class="property">target</span>.<span class="property">files</span>[<span class="number">0</span>]);</span></span><br><span class="line"><span class="language-javascript">                img.<span class="property">onload</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                    imgElement.<span class="property">width</span> = img.<span class="property">width</span></span></span><br><span class="line"><span class="language-javascript">                    imgElement.<span class="property">height</span> = img.<span class="property">height</span></span></span><br><span class="line"><span class="language-javascript">                    outputElement.<span class="property">width</span> = img.<span class="property">width</span></span></span><br><span class="line"><span class="language-javascript">                    outputElement.<span class="property">height</span> = img.<span class="property">height</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> context = imgElement.<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                    context.<span class="title function_">drawImage</span>(img, <span class="number">0</span>, <span class="number">0</span>);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;, <span class="literal">false</span>);</span></span><br><span class="line"><span class="language-javascript">            lutInput.<span class="title function_">addEventListener</span>(<span class="string">&#x27;change&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> img = <span class="keyword">new</span> <span class="title class_">Image</span></span></span><br><span class="line"><span class="language-javascript">                img.<span class="property">src</span> = <span class="variable constant_">URL</span>.<span class="title function_">createObjectURL</span>(e.<span class="property">target</span>.<span class="property">files</span>[<span class="number">0</span>]);</span></span><br><span class="line"><span class="language-javascript">                img.<span class="property">onload</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                    lutElement.<span class="property">width</span> = img.<span class="property">width</span></span></span><br><span class="line"><span class="language-javascript">                    lutElement.<span class="property">height</span> = img.<span class="property">height</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> context = lutElement.<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                    context.<span class="title function_">drawImage</span>(img, <span class="number">0</span>, <span class="number">0</span>);</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">applyLUT</span>(<span class="string">&quot;canvasOutput&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;, <span class="literal">false</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">function</span> <span class="title function_">applyLUT</span>(<span class="params">resultID</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> imageContext = imgElement.<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> lutContext = lutElement.<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> imageData = imageContext.<span class="title function_">getImageData</span>(<span class="number">0</span>, <span class="number">0</span>, imgElement.<span class="property">width</span>, imgElement.<span class="property">height</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> lutData = lutContext.<span class="title function_">getImageData</span>(<span class="number">0</span>, <span class="number">0</span>, lutElement.<span class="property">width</span>, lutElement.<span class="property">height</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; imageData.<span class="property">data</span>.<span class="property">length</span>; i += <span class="number">4</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> r = <span class="title class_">Math</span>.<span class="title function_">floor</span>(imageData.<span class="property">data</span>[i] / <span class="number">4</span>);</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> g = <span class="title class_">Math</span>.<span class="title function_">floor</span>(imageData.<span class="property">data</span>[i + <span class="number">1</span>] / <span class="number">4</span>);</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> b = <span class="title class_">Math</span>.<span class="title function_">floor</span>(imageData.<span class="property">data</span>[i + <span class="number">2</span>] / <span class="number">4</span>);</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> lutX = (b % <span class="number">8</span>) * <span class="number">64</span> + r;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> lutY = <span class="title class_">Math</span>.<span class="title function_">floor</span>(b / <span class="number">8</span>) * <span class="number">64</span> + g;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> lutIndex = (lutY * lutElement.<span class="property">width</span> + lutX) * <span class="number">4</span>;</span></span><br><span class="line"><span class="language-javascript">                    imageData.<span class="property">data</span>[i] = lutData.<span class="property">data</span>[lutIndex];</span></span><br><span class="line"><span class="language-javascript">                    imageData.<span class="property">data</span>[i + <span class="number">1</span>] = lutData.<span class="property">data</span>[lutIndex + <span class="number">1</span>];;</span></span><br><span class="line"><span class="language-javascript">                    imageData.<span class="property">data</span>[i + <span class="number">2</span>] = lutData.<span class="property">data</span>[lutIndex + <span class="number">2</span>];;</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(resultID).<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>).<span class="title function_">putImageData</span>(imageData, <span class="number">0</span>, <span class="number">0</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;downloadButton&#x27;</span>).<span class="property">onclick</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">              <span class="variable language_">this</span>.<span class="property">href</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;canvasOutput&#x27;</span>).<span class="title function_">toDataURL</span>();</span></span><br><span class="line"><span class="language-javascript">              <span class="variable language_">this</span>.<span class="property">download</span> = <span class="string">&#x27;image.png&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;;</span></span><br><span class="line"><span class="language-javascript">        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>效果如下，左边是原图，中间是3D LUT文件，右边是处理后的图，效果不错吧！</p>
<p><img src="/../images/2021/goingforawalk.png" alt="goingforawalk"></p>
<p>怎么样，效果是不是特别好？而且3D LUT不仅可以处理图片，还可以处理视频哦。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://gist.github.com/kishmiryan-karlen/559c190f6c20856ee323">A function that helps to apply LUT to image. Make sure to change the canvas IDs or to create temporary canvases</a></li>
<li><a target="_blank" rel="noopener" href="https://www.emanueleferonato.com/2018/06/09/playing-with-javascript-photos-and-3d-luts-lookup-tables/">Playing with JavaScript, photos and 3D LUTS (lookup tables)</a></li>
<li><a target="_blank" rel="noopener" href="https://purple11.com/free-luts/">free-luts</a></li>
<li><a target="_blank" rel="noopener" href="https://fixthephoto.com/film-emulation-luts">film-emulation-luts</a></li>
</ul>
</div><a href="/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/%E5%89%8D%E7%AB%AF%E5%A6%82%E4%BD%95%E9%80%9A%E8%BF%87LUT%E5%AE%9E%E7%8E%B0%E5%9B%BE%E7%89%87%E6%BB%A4%E9%95%9C/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/%E5%89%8D%E7%AB%AF%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8openCV/" class="post-title-link">前端如何使用openCV</a></h2><div class="post-info">2021-08-05<p id="busuanzi_container_page_pv" class="visit"><span id="busuanzi_value_page_pv"></span><span>次访问</span></p></div><div class="post-content"><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>OpenCV(Open Source Computer Vision Library)，是一个在图像处理和识别上很强大的库，最开始只有C++版本，但现在构建了各种不同语言的版本，比如Python和Java，甚至是JavaScript，本文要介绍的就是JavaScript版本的OpenCV.js。</p>
<h2 id="如何获取OpenCV-js"><a href="#如何获取OpenCV-js" class="headerlink" title="如何获取OpenCV.js"></a>如何获取OpenCV.js</h2><p>1、官方编译好的版本下载地址为：<br><a target="_blank" rel="noopener" href="https://docs.opencv.org/_VERSION_/opencv.js">https://docs.opencv.org/_VERSION_/opencv.js</a><br>其中 VERSION 换成你想要的版本。<br>目前最新的為 4.5.3 版本，那么下载地址就是<a target="_blank" rel="noopener" href="https://docs.opencv.org/4.5.3/opencv.js">https://docs.opencv.org/4.5.3/opencv.js</a></p>
<p>2、参照<a target="_blank" rel="noopener" href="https://docs.opencv.org/4.5.3/d4/da1/tutorial_js_setup.html">官网</a>自行构建<code>OpenCV.js</code></p>
<h2 id="实现一个简单的处理"><a href="#实现一个简单的处理" class="headerlink" title="实现一个简单的处理"></a>实现一个简单的处理</h2><p>图片灰度处理效果：</p>
<p><img src="/../images/2021/color_gray.png" alt="color_gray"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>OpenCV.js<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">            <span class="selector-class">.wrap-image</span> &#123;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">flex-direction</span>: row;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">margin-top</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">            &#125;</span></span><br><span class="line"><span class="language-css">            <span class="selector-class">.wrap-image</span> <span class="selector-tag">img</span>,</span></span><br><span class="line"><span class="language-css">            <span class="selector-class">.wrap-image</span> <span class="selector-tag">canvas</span> &#123;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">width</span>: <span class="number">300px</span>;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">margin-right</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">            &#125;</span></span><br><span class="line"><span class="language-css">        </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span> <span class="attr">id</span>=<span class="string">&quot;status&quot;</span>&gt;</span>Loading the Opencv ...<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;fileInput&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;wrap-image&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;imageUpload&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;No Image&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">&quot;canvasOutput&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> imgElement = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;imageUpload&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> inputElement = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;fileInput&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            inputElement.<span class="property">onchange</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">              imgElement.<span class="property">src</span> = <span class="variable constant_">URL</span>.<span class="title function_">createObjectURL</span>(event.<span class="property">target</span>.<span class="property">files</span>[<span class="number">0</span>]);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            imgElement.<span class="property">onload</span> =<span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">let</span> src = cv.<span class="title function_">imread</span>(<span class="string">&#x27;imageUpload&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">let</span> dst = <span class="keyword">new</span> cv.<span class="title class_">Mat</span>();</span></span><br><span class="line"><span class="language-javascript">                cv.<span class="title function_">cvtColor</span>(src, dst, cv.<span class="property">COLOR_RGBA2GRAY</span>, <span class="number">0</span>);</span></span><br><span class="line"><span class="language-javascript">                cv.<span class="title function_">imshow</span>(<span class="string">&#x27;canvasOutput&#x27;</span>, dst);</span></span><br><span class="line"><span class="language-javascript">                src.<span class="title function_">delete</span>(); dst.<span class="title function_">delete</span>();</span></span><br><span class="line"><span class="language-javascript">            &#125;;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">function</span> <span class="title function_">onOpenCvReady</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;status&#x27;</span>).<span class="title function_">remove</span>();</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">async</span> <span class="attr">src</span>=<span class="string">&quot;js/opencv.js&quot;</span> <span class="attr">onload</span>=<span class="string">&quot;onOpenCvReady();&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>代码解析：<br>1、opencv.js很大，载入时需要加上async，并设定onload来检测是否载入完成。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">async</span> <span class="attr">src</span>=<span class="string">&quot;js/opencv.js&quot;</span> <span class="attr">onload</span>=<span class="string">&quot;onOpenCvReady();&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、记得及时清理Mat对象，释放内存。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">src.<span class="title function_">delete</span>();</span><br><span class="line">dst.<span class="title function_">delete</span>();</span><br></pre></td></tr></table></figure>

<p>3、imread和imshow 必须传入 <code>&lt;img /&gt;</code> 或 <code>&lt;canvas /&gt;</code> 的 <code>id</code> 或是 <code>DOM</code>。</p>
<h2 id="下载图片"><a href="#下载图片" class="headerlink" title="下载图片"></a>下载图片</h2><p>图片处理好了，用户想要下载，那就再html中加上下载链接：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">id</span>=<span class="string">&quot;downloadButton&quot;</span>&gt;</span>下载<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后把下面的JavaScript加到之前的script标签中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;downloadButton&#x27;</span>).<span class="property">onclick</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">href</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;canvasOutput&#x27;</span>).<span class="title function_">toDataURL</span>();</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">download</span> = <span class="string">&#x27;image.png&#x27;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>总结<br>一旦你习惯了将图像作为Mat对象来操作，你就可以做更多的事情了,你可以在<a target="_blank" rel="noopener" href="https://docs.opencv.org/4.5.3/d5/d10/tutorial_js_root.html">OpenCV的网站</a>上找到更多的教程，包括人脸识别和模板匹配等等。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://hi-upchen.medium.com/%E5%A6%82%E4%BD%95%E5%9C%A8-nodejs-%E6%88%96%E5%89%8D%E7%AB%AF%E4%BD%BF%E7%94%A8-opencv-%E5%85%8D%E5%AE%89%E8%A3%9D-cc2fea289054">如何在 Nodejs 或前端使用 OpenCV（免安裝）. 在本機使用 OpenCV 很簡單，在伺服器端使用 OpenCV… | by Up Chen | Medium</a></li>
<li><a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/introduction-to-computer-vision-in-javascript-using-opencvjs">An Introduction to Computer Vision in JavaScript using OpenCV.js | DigitalOcean</a></li>
</ul>
</div><a href="/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/%E5%89%8D%E7%AB%AF%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8openCV/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/%E5%8A%A8%E6%95%88/SVG%20Path%E5%AE%9E%E7%8E%B0tooltips/" class="post-title-link">SVG Path实现tooltips</a></h2><div class="post-info">2020-11-25<p id="busuanzi_container_page_pv" class="visit"><span id="busuanzi_value_page_pv"></span><span>次访问</span></p><a href="https://medium.com/welldone-software/tooltips-using-svg-path-1bd69cc7becd" target="_blank" title="https://medium.com/welldone-software/tooltips-using-svg-path-1bd69cc7becd" class="post-from">原文地址</a></div><div class="post-content"><p>在地图指针之后，让我们来尝试下更多有趣的SVG Path形状：一个tooltip。<a target="_blank" rel="noopener" href="https://jsfiddle.net/mrovinsky/mmmpe817/">点击查看例子</a></p>
<p><img src="/../images/2020/svgTooltip.png" alt="svgTooltip"></p>
<p>tooltip形状的path路径是由5个变量决定的：<code>width</code>,<code>height</code>,<code>pointer offset</code>,<code>corner radius</code>和<code>placement</code>(left,top,right或bottom)。</p>
<p>简单来说，我们先来完成一个没有圆角的向上的tooltip，我们需要这么做：<br>1、移动到点A：M aX,aY<br>2、连线到点B：L bX,bY<br>3、垂直连线到点C：H cX<br>4、水平连线到点D：V dY<br>5、垂直连线到点E：H eX<br>6、水平连线到点F：V fY<br>7、垂直连线到点G：H gX<br>8、连线到点A：L aX,aY<br>9、结束路径：z</p>
<p>点A的坐标是(0,0)，其他点的坐标由width,height和offset计算出来：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bx =  -offset</span><br><span class="line">by = -offset <span class="comment">// cy,fy,gy也是一样的</span></span><br><span class="line">cx = -width / <span class="number">2</span> <span class="comment">// dx也一样</span></span><br><span class="line">dy = -offset - height <span class="comment">// ey也一样</span></span><br><span class="line">ex = width / <span class="number">2</span> <span class="comment">// fx也一样</span></span><br><span class="line">gx = offset</span><br></pre></td></tr></table></figure>

<p>整个路径实现出来就会是这样：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">topTooltipPath</span>(<span class="params">width, height, offset</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> left = -width / <span class="number">2</span></span><br><span class="line">  <span class="keyword">const</span> right = width / <span class="number">2</span></span><br><span class="line">  <span class="keyword">const</span> top = -offset - height</span><br><span class="line">  <span class="keyword">const</span> bottom = -offset</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`M 0,0</span></span><br><span class="line"><span class="string">    L <span class="subst">$&#123;-offset&#125;</span>,<span class="subst">$&#123;bottom&#125;</span></span></span><br><span class="line"><span class="string">    H <span class="subst">$&#123;left&#125;</span></span></span><br><span class="line"><span class="string">    V <span class="subst">$&#123;top&#125;</span></span></span><br><span class="line"><span class="string">    H <span class="subst">$&#123;right&#125;</span></span></span><br><span class="line"><span class="string">    V <span class="subst">$&#123;bottom&#125;</span></span></span><br><span class="line"><span class="string">    H <span class="subst">$&#123;offset&#125;</span></span></span><br><span class="line"><span class="string">    L 0,0 z`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码解释下就是：画笔移动到点M，再画直线到点B，再水平画直线到点C，再垂直画直线到点D，再水平画直线到点E，再垂直画直线到点F，再水平画直线到点G，再画直线到点M，并结束。 <strong>需要注意的是坐标系是左上角为原点，x轴正方向朝右，y轴正方向朝下。</strong></p>
<p>实现圆角，我们有2个方案：弧(Arc)和二次贝塞尔曲线(Quadratic Bezier curve)。<br>弧需要使用7个变量，但是二次贝塞尔曲线就要简单得多：它在当前路径上取得起点，另外2个点是顶点<code>(vX,vY)</code>和终点<code>(tX,tY)</code>。在SVG中，二次贝塞尔曲线的写法是<code>Q vX,vY tX,tY</code>。</p>
<p>拿圆角C来举例，设圆角半径是r,圆角的起点在B到C的水平直线上，，故起点坐标是<code>(cX+r, cY)</code>,终点在出圆角去点D的垂直直线上，故终点坐标是<code>(cX,cY-r)</code>，顶点就是点<code>C(cX,cY)</code>，把上面例子中的直角变成圆角，我们只需要把<code>H cX V dY</code>换成<code>H cX+r Q cX, cY cX, (cY - r) V dY</code>，这样就得到了半径是<code>r</code>的圆角<code>C</code>，下面是优化后的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">topTooltipPath</span>(<span class="params">width, height, offset, radius</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> left = -width / <span class="number">2</span></span><br><span class="line">  <span class="keyword">const</span> right = width / <span class="number">2</span></span><br><span class="line">  <span class="keyword">const</span> top = -offset - height</span><br><span class="line">  <span class="keyword">const</span> bottom = -offset</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`M 0,0</span></span><br><span class="line"><span class="string">    L <span class="subst">$&#123;-offset&#125;</span>,<span class="subst">$&#123;bottom&#125;</span></span></span><br><span class="line"><span class="string">    H <span class="subst">$&#123;left + radius&#125;</span></span></span><br><span class="line"><span class="string">    Q <span class="subst">$&#123;left&#125;</span>,<span class="subst">$&#123;bottom&#125;</span> <span class="subst">$&#123;left&#125;</span>,<span class="subst">$&#123;bottom - radius&#125;</span></span></span><br><span class="line"><span class="string">    V <span class="subst">$&#123;top + radius&#125;</span></span></span><br><span class="line"><span class="string">    Q <span class="subst">$&#123;left&#125;</span>,<span class="subst">$&#123;top&#125;</span> <span class="subst">$&#123;left + radius&#125;</span>,<span class="subst">$&#123;top&#125;</span></span></span><br><span class="line"><span class="string">    H <span class="subst">$&#123;right - radius&#125;</span></span></span><br><span class="line"><span class="string">    Q <span class="subst">$&#123;right&#125;</span>,<span class="subst">$&#123;top&#125;</span> <span class="subst">$&#123;right&#125;</span>,<span class="subst">$&#123;top + radius&#125;</span></span></span><br><span class="line"><span class="string">    V <span class="subst">$&#123;bottom - radius&#125;</span></span></span><br><span class="line"><span class="string">    Q <span class="subst">$&#123;right&#125;</span>,<span class="subst">$&#123;bottom&#125;</span> <span class="subst">$&#123;right - radius&#125;</span>,<span class="subst">$&#123;bottom&#125;</span></span></span><br><span class="line"><span class="string">    H <span class="subst">$&#123;offset&#125;</span></span></span><br><span class="line"><span class="string">    L 0,0 z`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获得圆角的向下的tooltip，我们只需要把路径中的Y坐标全部取反：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">bottomTooltipPath</span>(<span class="params">width, height, offset, radius</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> left = -width / <span class="number">2</span></span><br><span class="line">  <span class="keyword">const</span> right = width / <span class="number">2</span></span><br><span class="line">  <span class="keyword">const</span> bottom = offset + height</span><br><span class="line">  <span class="keyword">const</span> top = offset</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`M 0,0</span></span><br><span class="line"><span class="string">    L <span class="subst">$&#123;-offset&#125;</span>,<span class="subst">$&#123;top&#125;</span></span></span><br><span class="line"><span class="string">    H <span class="subst">$&#123;left + radius&#125;</span></span></span><br><span class="line"><span class="string">    Q <span class="subst">$&#123;left&#125;</span>,<span class="subst">$&#123;top&#125;</span> <span class="subst">$&#123;left&#125;</span>,<span class="subst">$&#123;top + radius&#125;</span></span></span><br><span class="line"><span class="string">    V <span class="subst">$&#123;bottom - radius&#125;</span></span></span><br><span class="line"><span class="string">    Q <span class="subst">$&#123;left&#125;</span>,<span class="subst">$&#123;bottom&#125;</span> <span class="subst">$&#123;left + radius&#125;</span>,<span class="subst">$&#123;bottom&#125;</span></span></span><br><span class="line"><span class="string">    H <span class="subst">$&#123;right - radius&#125;</span></span></span><br><span class="line"><span class="string">    Q <span class="subst">$&#123;right&#125;</span>,<span class="subst">$&#123;bottom&#125;</span> <span class="subst">$&#123;right&#125;</span>,<span class="subst">$&#123;bottom - radius&#125;</span></span></span><br><span class="line"><span class="string">    V <span class="subst">$&#123;top + radius&#125;</span></span></span><br><span class="line"><span class="string">    Q <span class="subst">$&#123;right&#125;</span>,<span class="subst">$&#123;top&#125;</span> <span class="subst">$&#123;right - radius&#125;</span>,<span class="subst">$&#123;top&#125;</span></span></span><br><span class="line"><span class="string">    H <span class="subst">$&#123;offset&#125;</span></span></span><br><span class="line"><span class="string">    L 0,0 z`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样的可以得到朝左和朝右的tooltip:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">leftTooltipPath</span>(<span class="params">width, height, offset, radius</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> left = -offset - width</span><br><span class="line">  <span class="keyword">const</span> right = -offset</span><br><span class="line">  <span class="keyword">const</span> top = -height / <span class="number">2</span></span><br><span class="line">  <span class="keyword">const</span> bottom = height / <span class="number">2</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">`M 0,0</span></span><br><span class="line"><span class="string">    L <span class="subst">$&#123;right&#125;</span>,<span class="subst">$&#123;-offset&#125;</span></span></span><br><span class="line"><span class="string">    V <span class="subst">$&#123;top + radius&#125;</span></span></span><br><span class="line"><span class="string">    Q <span class="subst">$&#123;right&#125;</span>,<span class="subst">$&#123;top&#125;</span> <span class="subst">$&#123;right - radius&#125;</span>,<span class="subst">$&#123;top&#125;</span></span></span><br><span class="line"><span class="string">    H <span class="subst">$&#123;left + radius&#125;</span></span></span><br><span class="line"><span class="string">    Q <span class="subst">$&#123;left&#125;</span>,<span class="subst">$&#123;top&#125;</span> <span class="subst">$&#123;left&#125;</span>,<span class="subst">$&#123;top + radius&#125;</span></span></span><br><span class="line"><span class="string">    V <span class="subst">$&#123;bottom - radius&#125;</span></span></span><br><span class="line"><span class="string">    Q <span class="subst">$&#123;left&#125;</span>,<span class="subst">$&#123;bottom&#125;</span> <span class="subst">$&#123;left + radius&#125;</span>,<span class="subst">$&#123;bottom&#125;</span></span></span><br><span class="line"><span class="string">    H <span class="subst">$&#123;right - radius&#125;</span></span></span><br><span class="line"><span class="string">    Q <span class="subst">$&#123;right&#125;</span>,<span class="subst">$&#123;bottom&#125;</span> <span class="subst">$&#123;right&#125;</span>,<span class="subst">$&#123;bottom - radius&#125;</span></span></span><br><span class="line"><span class="string">    V <span class="subst">$&#123;offset&#125;</span></span></span><br><span class="line"><span class="string">    L 0,0 z`</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">rightTooltipPath</span>(<span class="params">width, height, offset, radius</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> left = offset</span><br><span class="line">  <span class="keyword">const</span> right = offset + width</span><br><span class="line">  <span class="keyword">const</span> top = -height / <span class="number">2</span></span><br><span class="line">  <span class="keyword">const</span> bottom = height / <span class="number">2</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">`M 0,0</span></span><br><span class="line"><span class="string">    L <span class="subst">$&#123;left&#125;</span>,<span class="subst">$&#123;-offset&#125;</span></span></span><br><span class="line"><span class="string">    V <span class="subst">$&#123;top + radius&#125;</span></span></span><br><span class="line"><span class="string">    Q <span class="subst">$&#123;left&#125;</span>,<span class="subst">$&#123;top&#125;</span> <span class="subst">$&#123;left + radius&#125;</span>,<span class="subst">$&#123;top&#125;</span></span></span><br><span class="line"><span class="string">    H <span class="subst">$&#123;right - radius&#125;</span></span></span><br><span class="line"><span class="string">    Q <span class="subst">$&#123;right&#125;</span>,<span class="subst">$&#123;top&#125;</span> <span class="subst">$&#123;right&#125;</span>,<span class="subst">$&#123;top + radius&#125;</span></span></span><br><span class="line"><span class="string">    V <span class="subst">$&#123;bottom - radius&#125;</span></span></span><br><span class="line"><span class="string">    Q <span class="subst">$&#123;right&#125;</span>,<span class="subst">$&#123;bottom&#125;</span> <span class="subst">$&#123;right - radius&#125;</span>,<span class="subst">$&#123;bottom&#125;</span></span></span><br><span class="line"><span class="string">    H <span class="subst">$&#123;left + radius&#125;</span></span></span><br><span class="line"><span class="string">    Q <span class="subst">$&#123;left&#125;</span>,<span class="subst">$&#123;bottom&#125;</span> <span class="subst">$&#123;left&#125;</span>,<span class="subst">$&#123;bottom - radius&#125;</span></span></span><br><span class="line"><span class="string">    V <span class="subst">$&#123;offset&#125;</span></span></span><br><span class="line"><span class="string">    L 0,0 z`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/SVG/Tutorial/Paths">SVG Paths | MDN</a></li>
</ul>
</div><a href="/%E5%8A%A8%E6%95%88/SVG%20Path%E5%AE%9E%E7%8E%B0tooltips/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/%E5%8A%A8%E6%95%88/lottie-web%E5%BA%94%E7%94%A8%E4%BC%98%E5%8C%96%E4%B9%8BBase64/" class="post-title-link">lottie-web应用优化之Base64</a></h2><div class="post-info">2019-04-28<p id="busuanzi_container_page_pv" class="visit"><span id="busuanzi_value_page_pv"></span><span>次访问</span></p></div><div class="post-content"><p><a target="_blank" rel="noopener" href="https://lovelyun.github.io/js/lottie-web%E5%BA%94%E7%94%A8%E4%BC%98%E5%8C%96/">前文</a>的优化中，主要把设计输出的多张图片合并成1张雪碧图，减小了图片请求次数和资源大小。<br>每次新的动效出来，还需要开发介入处理。</p>
<p>本文的优化主要解决2个问题：<br>1、资源文件多，不方便发布。<br>前文优化后，有3个文件，1个html，1个json，1个png的雪碧图。<br>本文优化后，只有1个html文件。</p>
<p>2、需要开发介入。<br>前文优化后，需要开发处理雪碧图生成、json数据改造、雪碧图压缩等等。<br>本文优化后，不需要开发介入。设计用AE导出资源后，通过前端提供的工具，自动生成html代码，这个html文件直接发布即可。</p>
<p>优化方案：通过Electron，开发出一个桌面应用，这个应用将自动处理所有需要开发介入的事情。</p>
<h2 id="Electron"><a href="#Electron" class="headerlink" title="Electron"></a>Electron</h2><p>Electron 是一个使用 JavaScript, HTML 和 CSS 等 Web 技术创建原生程序的框架。<br>【<a target="_blank" rel="noopener" href="https://electronjs.org/docs/tutorial/first-app">打造你的第一个 Electron 应用</a>】一文可以让你快速上手Electron。</p>
<h2 id="动效生成器"><a href="#动效生成器" class="headerlink" title="动效生成器"></a>动效生成器</h2><h3 id="界面"><a href="#界面" class="headerlink" title="界面"></a>界面</h3><p>启动Electron应用，会打开一个界面，本文叫做HTML动效生成器，界面中收集3个信息：<br>1、AE导数的demo文件夹；<br>2、动效尺寸宽<br>3、动效尺寸高</p>
<p>比如demo文件在桌面，那么在demo文件夹路径的输入框中直接填入地址：C:\Users\win\Desktop\demo<br>因为默认导出的数据尺寸宽高是100%，大小不固定，所以还需收集尺寸信息。动效宽高填设计元素的宽高即可（单位px）。</p>
<p><img src="/../images/2019/electron.png" alt="electron"></p>
<h3 id="生成逻辑"><a href="#生成逻辑" class="headerlink" title="生成逻辑"></a>生成逻辑</h3><p>逻辑写在<code>renderer.js</code>中。<br>设计输出资源的目录demo文件夹的结构是这样的：<br>.<br>├── images<br>│ ├── img_0.png<br>│ ├── img_1.png<br>│ ├── img_2.png<br>│ ├── …<br>├── demo.html<br>├── lottie.js<br>└── data.json</p>
<p>点击生成资源按钮时，<br>1、获取images文件夹下的图片资源。主要用到node文件系统fs的readdirSync。<br>2、将图片转成Base64。主要用到readFileSync来读取文件、Buffer.from将读取到的文件转成Base64。<br>3、更改data.json中的assets字段，将代表图片相对路径的p字段置空，将代表图片的u字段改成Base64。这样png图片文件就Base64编码整个进data.json文件了。更改字段主要是先readFileSync读取utf8格式文件，然后将读取的数据转成json格式，重新将要更改的字段赋值，然后转成字符串writeFileSync写入data.json。<br>然后点击创建按钮，<br>1、重写index.html文件，把动效尺寸宽高重写，把data.json文件的数据整个进html。<br>2、把重写后的index.html文件输出到demo文件夹下，这个index.html就是我们最终想要的文件。</p>
<div class="tip">
1、注意本地文件相对路径的写法，需要用path来拼接，如果直接写相对路径，在打包后相对路径发生变化会导致文件找不到

<p>2、重写，复制等文件操作其实主要就是node fs文件系统的读和写，必要的时候做一个格式转换。</p>
</div>

<p><code>static/index.html</code>是index.html的模版文件，主要是删除设计输出的demo.html文件的多余信息，lottie库通过script引入而不是直接在html中，animationData置空，生成的时候会重写。</p>
<h3 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h3><p>参考官网的<a target="_blank" rel="noopener" href="https://electronjs.org/docs/tutorial/application-packaging">应用程序打包</a>，选择<a target="_blank" rel="noopener" href="https://github.com/electron-userland/electron-packager">electron-packager</a>来打包，打包后生成<code>.exe</code>可执行文件，双击即可启动该桌面应用。<br>至此，自动生成代码的小工具就完成啦。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>数据对比：</p>
<table>
<thead>
<tr>
<th></th>
<th>webp格式动图</th>
<th>HTML</th>
<th>HTML格式雪碧图优化</th>
<th>HTML格式Base64优化</th>
</tr>
</thead>
<tbody><tr>
<td>总流量</td>
<td>2M</td>
<td>258.2k</td>
<td>139.3k</td>
<td>161k</td>
</tr>
<tr>
<td>图片请求次数</td>
<td>1</td>
<td>18</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>总请求次数</td>
<td>1</td>
<td>21</td>
<td>3</td>
<td>2</td>
</tr>
</tbody></table>
</div><a href="/%E5%8A%A8%E6%95%88/lottie-web%E5%BA%94%E7%94%A8%E4%BC%98%E5%8C%96%E4%B9%8BBase64/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/node/%E5%88%9B%E5%BB%BANodeJS%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8C%85%E6%8C%87%E5%8D%97/" class="post-title-link">创建NodeJS命令行包指南</a></h2><div class="post-info">2019-04-26<p id="busuanzi_container_page_pv" class="visit"><span id="busuanzi_value_page_pv"></span><span>次访问</span></p><a href="https://medium.com/netscape/a-guide-to-create-a-nodejs-command-line-package-c2166ad0452e" target="_blank" title="https://medium.com/netscape/a-guide-to-create-a-nodejs-command-line-package-c2166ad0452e" class="post-from">原文地址</a></div><div class="post-content"><p>受到启发要创建一个NodeJS命令行脚本来解决特定的问题？您想要将命令行作为可安装包发布吗？这应该很简单，对吧?幸运的是,它确实很简单！</p>
<p>下面是关于创建NodeJS命令行包的简明指南。</p>
<p>本指南将引导您创建、映射和链接NodeJS命令行脚本。</p>
<h2 id="创建node包"><a href="#创建node包" class="headerlink" title="创建node包"></a>创建node包</h2><p>首先，我们需要创建NodeJS包，比如只包含一个<code>package.json</code>文件的目录。我们可以简单地分两步来做：<br>1、创建一个空目录；<br>2、在目录下运行<code>npm init</code>。</p>
<p>这对于创建NodeJS命令行包并不是什么新鲜事，也不是特殊的，因为它是任何NodeJS包的起点。下面让我们创建NodeJS命令行脚本。</p>
<h2 id="创建NodeJS命令行脚本"><a href="#创建NodeJS命令行脚本" class="headerlink" title="创建NodeJS命令行脚本"></a>创建NodeJS命令行脚本</h2><p>你可能已经知道我们可以通过运行<code>node script.js</code>来执行一段NodeJS脚本，这在大多数情况下是可行的，但是NodeJS命令行脚本除了包含一个特殊的shell指令外，就是一个常规的JavaScript文件，这个稍后再详细介绍。首先，让我们创建一个JavaScript文件，它将成为NodeJS命令行脚本。</p>
<h3 id="创建JavaScript文件"><a href="#创建JavaScript文件" class="headerlink" title="创建JavaScript文件"></a>创建JavaScript文件</h3><p><a target="_blank" rel="noopener" href="https://docs.npmjs.com/files/package.json#bin">npm官方文档</a>和流行的NodeJS项目通常将JavaScript命令行文件命名为<code>cli.js</code>。这个命名非常好，因为它的名字就说明了它的作用。</p>
<h3 id="JavaScript文件转成NodeJS命令行脚本"><a href="#JavaScript文件转成NodeJS命令行脚本" class="headerlink" title="JavaScript文件转成NodeJS命令行脚本"></a>JavaScript文件转成NodeJS命令行脚本</h3><p>和其他shell脚本类似，我想通过本地安装的node来运行我们的JavaScript文件，所以我们在JavaScript文件的顶部添加一个<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Shebang_%28Unix%29">shebang</a>字符序列：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env node</span></span><br></pre></td></tr></table></figure>

<p>这样，我们就告诉*nix系统，JavaScript文件的解释器应该是<code>/usr/bin/env node</code>，它查找本地安装的node。<br>在Windows系统中,这行会被忽略，因为它被看成注释，但是它是必须的，因为在Windows机器上<code>npm</code>会在NodeJS命令行包安装的时候读取它。</p>
<h3 id="让JavaScript命令行文件可执行"><a href="#让JavaScript命令行文件可执行" class="headerlink" title="让JavaScript命令行文件可执行"></a>让JavaScript命令行文件可执行</h3><p>在大多数情况下，不允许执行新文件。在创建将要执行的NodeJS命令行脚本时，我们需要修改它的文件权限。在*nix系统中，您可以这样做:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x cli.js           # 让cli.js文件可执行</span><br></pre></td></tr></table></figure>

<p>现在我们给脚本文件加点儿代码，我们将创建一个简单的<code>Hello World</code>，并打印一些提供的变量。</p>
<h3 id="给NodeJS命令行文件增加代码"><a href="#给NodeJS命令行文件增加代码" class="headerlink" title="给NodeJS命令行文件增加代码"></a>给NodeJS命令行文件增加代码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env node</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> [,,...args] = process.<span class="property">argv</span> <span class="comment">// 取变量</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hello World <span class="subst">$&#123;args&#125;</span>`</span>) <span class="comment">// 打印Hello World和变量</span></span><br></pre></td></tr></table></figure>

<p>现在我们可以运行它，在Linux 和 Mac OS X系统运行<code>./cli.js</code>，在Windows系统运行<code>node.cmd cli.js</code>。<br>试试看！试试传递一些变量给它。<br><img src="/../images/2019/nodecli.png" alt="nodecli"></p>
<p>到现在为止，我们在Linux和Mac OS X上可以像普通的javascript文件一样运行我们的NodeJS命令行文件，但是在Windows中我们仍然需要增加<code>node.cmd</code>。此外，我们使用文件名来执行命令行脚本，这并不好。在下一节中，我们将避开这些问题。</p>
<h2 id="命令行脚本映射到命令名"><a href="#命令行脚本映射到命令名" class="headerlink" title="命令行脚本映射到命令名"></a>命令行脚本映射到命令名</h2><p>到现在为止，我们将JavaScript文件变成了NodeJS命令行文件，然而，我们希望给它一个更有意义的名字，而不是NodeJS命令行脚本文件的名字。为此，我们需要配置<code>package.json</code>来映射命令行脚本和命令名。<a target="_blank" rel="noopener" href="https://docs.npmjs.com/files/package.json#bin">npm官网</a>是这么说的：</p>
<blockquote>
<p>在<code>package.json</code>中提供一个bin字段，表示命令名到本地文件名的映射。</p>
</blockquote>
<p>这意味着我们可以为本地的JavaScript脚本指定一个命令名称，比如我们像让<code>cli.js</code>脚本映射到<code>say-hello</code>命令，我们可以像上面提到的那样增加<code>bin</code>字段到<code>package.json</code>：</p>
<p><img src="/../images/2019/node-bin-sayhello.png" alt="node-bin-sayhello"></p>
<p>我们为bin字段分配了一个对象，其中键成为命令名，值是映射到NodeJS命令行脚本文件的对象。这种格式允许我们作为开发人员提供多个脚本映射。但是，如果我们想提供一个与它的文件同名的NodeJS命令行脚本，我们可以设置一个字符串表示本地文件路径，而不是一个对象。</p>
<h3 id="命令命名"><a href="#命令命名" class="headerlink" title="命令命名"></a>命令命名</h3><p>我们可以为命令选择任何名称，但我们不希望它与现有的流行命令名称(如ls、cd、dir等)发生冲突。如果我们使用一个现有的名称，脚本很可能不会被执行，而是执行现有现有的命令(结果可能不同)。</p>
<h2 id="链接开发命令"><a href="#链接开发命令" class="headerlink" title="链接开发命令"></a>链接开发命令</h2><p><code>npm link</code>命令允许我们在本地“符号链接一个包文件夹”，根据我们的需要，它将在本地安装package.json里bin字段中列出的任何命令。换句话说，<code>npm link</code>就像一个NodeJS包安装模拟器。值得一提的是，<code>npm link</code>有更广泛的用途，超出了本指南的范围。</p>
<p><code>npm link</code>命令是从我们想符号链接的NodeJS包目录中使用的:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm link</span><br></pre></td></tr></table></figure>

<p>执行后，我们将看到命令被全局符号链接。现在，我们可以用它自己的命令名称say-hello来执行NodeJS命令行脚本:</p>
<p><img src="/../images/2019/node-sayhello.png" alt="node-sayhello"></p>
<p>非常简洁有没有？这样我们就能在<code>npm publish</code>之前本地运行NodeJS命令行脚本。</p>
<h3 id="npm-link说明"><a href="#npm-link说明" class="headerlink" title="npm link说明"></a>npm link说明</h3><p>在底层，npm链接(也适用于npm安装)符号链接package.json bin字段中指定的所有文件。npmjs文档说:</p>
<blockquote>
<p>在安装时，npm将符号链接文件到prefix&#x2F;bin中用于全局安装，或者.&#x2F;node_modules&#x2F;.bin&#x2F;用于本地安装。</p>
</blockquote>
<p>在*nix系统上，npm链接过程类似于为指定的命令文件创建快捷方式，该命令文件将由shell执行，然后由node执行(因为指定了#!&#x2F;usr&#x2F;bin&#x2F;env node)。<br>在Windows上，npm会做相同的事情（如果指定了运行环境），然而它还会创建<code>&#123;command-name&#125;.cmd</code>来让<code>node</code>执行我们特殊的命令行文件&#x2F;</p>
<h3 id="保持目录整洁"><a href="#保持目录整洁" class="headerlink" title="保持目录整洁"></a>保持目录整洁</h3><p>当我们的符号链接命令测试通过后，可能会想删除它。<br>为此，我们可以在包目录下运行下面的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm unlink                   // 不再安装</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上就是关于创建NodeJS命令行包的简明指南。<br>通过这四个步骤，我们已经具备了发布NodeJS包的基础知识，该包将安装命令行包。<br>现在，你可以commit,push你的NodeJS命令行包代码来解放你的创造力了。如果您这样做了，请在评论中通过GitHub链接给我留言，这样我就可以偷看了。</p>
<h2 id="推荐"><a href="#推荐" class="headerlink" title="推荐"></a>推荐</h2><p>最后，这些是我在自己的命令行项目中用到的工具：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/sindresorhus/meow">meow – 简单的命令行工具</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/chalk/chalk">chalk - 终端字符样式</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/yargs/yargs">yargs - 命令行options解析</a></li>
</ul>
</div><a href="/node/%E5%88%9B%E5%BB%BANodeJS%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8C%85%E6%8C%87%E5%8D%97/" class="read-more">...more</a></article></li></ul><div class="right-container"><div class="widget"><div class="category"><h4>分类归档</h4><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ai/">ai</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/css/">css</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/doc/">doc</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/node/">node</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8A%A8%E6%95%88/">动效</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/">图像处理</a><span class="category-list-count">13</span></li></ul></div></div><div class="widget"><div class="tagcloud"><h4>标签云</h4></div></div><div class="widget"><div class="recent"><h4>最近文章</h4><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/css/%E8%AF%A6%E8%A7%A3CSS%20Grid%E5%B8%83%E5%B1%80/">详解CSS Grid布局</a></li><li class="post-list-item"><a class="post-list-link" href="/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/Shutterstock%20Editor%E5%85%B3%E4%BA%8ECanvas%E5%92%8CWebGL%E5%9B%BE%E7%89%87%E6%BB%A4%E9%95%9C%E7%9A%84%E5%AE%9E%E7%8E%B0/">Shutterstock Editor关于Canvas和WebGL图片滤镜的实现</a></li><li class="post-list-item"><a class="post-list-link" href="/js/javascript%E5%BC%82%E6%AD%A5error/">javascript异步error</a></li><li class="post-list-item"><a class="post-list-link" href="/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/win10%E7%BC%96%E8%AF%91opencvjs/">win10编译opencvjs</a></li><li class="post-list-item"><a class="post-list-link" href="/js/%E5%89%8D%E7%AB%AF%E5%8C%85%E7%AE%A1%E7%90%86%E5%99%A8/">前端包管理器</a></li></ul></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/page/2/" class="prev">PREV</a><a href="/page/4/" class="next">NEXT</a></div><div class="copyright"><p>© 2018 - 2024 <a href="https://github.com/lovelyun" target="_blank">Lovelyun</a></p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="https://apps.bdimg.com/libs/jquery/1.8.2/jquery.min.js"></script><script src="https://bubuzou.oss-cn-shenzhen.aliyuncs.com/blog/202010/articleCatalog.js"></script><script src="https://bubuzou.oss-cn-shenzhen.aliyuncs.com/blog/202010/main.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>